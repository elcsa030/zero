name: Criterion
on: [pull_request]
jobs:
  bench:
    runs-on: [self-hosted, bench, "${{ matrix.os }}", "${{ matrix.device }}"]

    strategy:
      fail-fast: false
      matrix:
        os: [Linux, macOS]
        feature: [default]
        device: [cpu]
        include:
          - os: Linux
            feature: cuda
            device: nvidia_rtx_a5000
          - os: macOS
            feature: metal
            device: intel_uhd_630
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_URL: https://github.com/mozilla/sccache/releases/download
      SCCACHE_VERSION: v0.3.3

    steps:
      - uses: risc0/actions-rs-toolchain@v1
        with:
          toolchain: stable
      - name: Prepare environment (Linux)
        if: matrix.os == 'Linux'
        run: |
          echo "SCCACHE_ARCH=x86_64-unknown-linux-musl" >> $GITHUB_ENV
      - name: Prepare environment (macOS)
        if: matrix.os == 'macOS'
        run: |
          echo "SCCACHE_ARCH=x86_64-apple-darwin" >> $GITHUB_ENV
      - name: Install sccache
        run: |
          SCCACHE_FILE=sccache-$SCCACHE_VERSION-$SCCACHE_ARCH
          curl -L "$SCCACHE_URL/$SCCACHE_VERSION/$SCCACHE_FILE.tar.gz" | tar xz
          mkdir -p $HOME/.local/bin
          mv -f $SCCACHE_FILE/sccache $HOME/.local/bin/sccache
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - uses: actions/checkout@v3
      - uses: risc0/criterion-compare-action@v3
        with:
          benchName: "fib"
          branchName: ${{ github.base_ref }}
          features: ${{ matrix.feature }}

      # - uses: actions/checkout@v3
      #   with:
      #     fetch-depth: 2
      #     ref: main
      # - name: Baseline
      #   run: cargo bench -F $FEATURE --bench fib

      # - uses: actions/checkout@v3
      #   with:
      #     fetch-depth: 2
      # - name: Benchmark
      #   run: cargo bench -F $FEATURE --bench fib

      # - run: sccache --show-stats

      # - uses: actions/upload-artifact@v3
      #   with:
      #     name: report
      #     path: target/criterion
