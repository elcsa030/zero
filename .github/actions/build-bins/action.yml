name: build binaries
inputs:
  os:
    required: true
  target:
    required: true
  tag:
    required: true
    default: ${{ github.ref }}
  repo_token:
    required: true
env:
  RUSTC_WRAPPER: sccache
runs:
  using: composite
  steps:
    - uses: actions/checkout@v3
      with:
        lfs: true
    - uses: ./.github/actions/rustup
    - uses: ./.github/actions/sccache
      with:
        key: ${{ inputs.os }}
    - run: yum -y install openssl-devel perl-core zlib-devel
      shell: bash
      if: inputs.os == 'Linux'
    - run: cargo build -p cargo-risczero --release
      shell: bash
    - run: |
        mkdir -p tmp/pkg
        cp target/release/cargo-risczero tmp/pkg
        cp target/release/r0vm tmp/pkg
        cd tmp/pkg && tar cv * | gzip -9 > ../cargo-risczero-${{ inputs.target }}.tgz
      shell: bash
    - uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ inputs.repo_token }}
        file: tmp/cargo-risczero-${{ inputs.target }}.tgz
        tag: ${{ inputs.tag }}
    - run: cargo install cargo-binstall
      shell: bash
    - run: cargo binstall --force cargo-risczero@${{ inputs.tag }}
      shell: bash
    - run: cargo run
      shell: bash
      working-directory: tools/smoke-test
